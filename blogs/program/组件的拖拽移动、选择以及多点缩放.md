---
title: 组件的拖拽移动、选择以及多点缩放
date: 2021-12-06
categories:
 - program
tags:
 - 线性代数
 - 低代码
publish: false
---

我们经常在一些可视化编辑其中看到这么个功能；可以随意拖拽某个组件，然后对其进行旋转、缩放。这其中涉及到一部分的数学知识，本文将详细描述这些功能都是如何实现的。

## 准备

首先我们需要抽象出单独的控制点组件，这样里面可以放置任意其他的组件，所有的缩放、旋转和移动均在控制点组件上执行。

大致结构
```html
<div>
  <div> <!-- 控制点组件 -->
    <div class="n"></div> <!-- 八个控制点 -->
    <div class="ne"></div> <!-- 八个控制点 -->
    <div class="e"></div> <!-- 八个控制点 -->
    <div class="se"></div> <!-- 八个控制点 -->
    <div class="s"></div> <!-- 八个控制点 -->
    <div class="sw"></div> <!-- 八个控制点 -->
    <div class="w"></div> <!-- 八个控制点 -->
    <div class="nw"></div> <!-- 八个控制点 -->
    <div class="rectangle"></div> <!--具体组件，这里用长方形-->
  </div>
</div>
```

给八个控制点添加上样式，即如图所示：

![1638775904](http://image.kkopite.cn/1638775904.png)

其次我们需要定义几个属性对应图形的大小、位置等

```js
const state = reactive({
  width: 100,
  height: 100,
  x: 100,
  y: 100,
  rotate: 0
})


// 然后将其转换成相应样式给控制点组件
const myStyle = computed(() => {
  return {
    width: `${state.width}px`,
    height: `${state.height}px`,
    top: `${state.y}px`,
    left: `${state.x}px`,
    transform: `rotate(${state.rotate}deg)`
  }
})

```

## 移动

拖拽移动的功能相对来说较为简单，只需要记住点击时的鼠标位置，以及初始位置（x,y）然后再每个移动事件中获取到的鼠标位置和之前记录的鼠标位置相减即可得到组件移动的相对位置，然后加上初始位置即可到到新的移动位置。

配合上示意图就很容易理解了，红色表示首次点击所处的位置，蓝色表示某次移动的位置：




```js
const handleMove = (e) => {
  const startX = e.pageX - state.x
  const startY = e.pageY - state.y

  const move = (e) => {
    state.x = e.pageX - startX
    state.y = e.pageY - startY
  }

  const up = () => {
    document.removeEventListener('mousemove', move)
    document.removeEventListener('mouseup', up)
  }

  document.addEventListener('mousemove', move)
  document.addEventListener('mouseup', up)
}

```

监听控制点组件的点击事件：

```html
  <div
    @mousedown="handleMove"
  >
    ...
  </div>
```

## 旋转

首先我们需要再新建一个选择点的控制点

```diff
<div>
  <div> <!-- 控制点组件 -->
+   <div class="control-rotate" /> <!-- 旋转控制点 -->
    <div class="n"></div> <!-- 八个控制点 -->
    <div class="ne"></div> <!-- 八个控制点 -->
    <div class="e"></div> <!-- 八个控制点 -->
    <div class="se"></div> <!-- 八个控制点 -->
    <div class="s"></div> <!-- 八个控制点 -->
    <div class="sw"></div> <!-- 八个控制点 -->
    <div class="w"></div> <!-- 八个控制点 -->
    <div class="nw"></div> <!-- 八个控制点 -->
    <div class="rectangle"></div> <!--具体组件，这里用长方形-->
  </div>
</div>
```

同理也是监听该点的鼠标事件，记录首次鼠标的坐标位置A，然后每次鼠标移动事件中获取新的坐标位置B，一般我们都是绕着组件中心点旋转的，因此还需要获取组件中心的坐标O。然后我们既可以计算出A和B相对O的坐标`(x1,y1)`,`(x2,y2)`，然后使用`Math.atan`方法计算两个点相对于中心的偏移角度，相减再加上初始角度即可得到我们想要的旋转角度。

代码如下：


```javascript
const handleCircle = (e) => {
  // 获取组件的中心坐标
  const rect = el.value.getBoundClientRect()
  const center = {
    x: rect.left + rect.width
    y: rect.top + rect.height
  }
  const rect = el.value.getBoundingClientRect()
  const center = {
    x: rect.left + rect.width / 2,
    y: rect.top + rect.height / 2
  }

  // 初始角度
  const startRotate = state.rotate

  const startX = e.pageX - center.x
  const startY = e.pageY - center.y
  // 首次点击的角度值
  const before = Math.atan2(startY, startX) * 180 / Math.PI

  const move = (e) => {
    const currentX = e.pageX - center.x
    const currentY = e.pageY - center.y

    
    const after = Math.atan2(currentY, currentX) * 180 / Math.PI
    state.rotate = startRotate + after - before
  }

  const up = () => {
    document.removeEventListener('mousemove', move)
    document.removeEventListener('mouseup', up)
  }

  document.addEventListener('mousemove', move)
  document.addEventListener('mouseup', up)
}


```

## 缩放

缩放这个功能较为复杂，八个控制的功能看上去似乎不同（实际上是类似的，后面会做出相应解释）：例如拖动左上角的控制点时，需保持右下角的点不动，然后根据拖动位置对组件进行缩放；亦或是右边中点，需保持左侧一条边位置和高度不变，根据拖动位置对组件的宽度进行缩放...

下面我们先只考虑拖动左上角控制点这种情况

### 拖动左上角

由于右下角是不动的，因此首先我们获取右下角的坐标：

```javascript

```
